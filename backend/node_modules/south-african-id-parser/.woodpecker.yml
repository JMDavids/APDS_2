when:
  branch:
    exclude: pages

pipeline:
  test:
    image: node:lts
    commands:
      - npm install
      - npm test
  audit:
    image: node:lts
    commands:
      - npm audit

  docs:
    image: node:lts
    commands:
      - npm run docs

  publish-pages:
    image: rust:latest
    secrets: [ cbtoken ]
    commands:
      - git config --global user.email "woodpecker@worthe-it.co.za"
      - git config --global user.name "CI Builder"
      - git clone -b pages https://$CBTOKEN@codeberg.org/$CI_REPO.git pages
      - cp -r dist/docs "pages/$CI_COMMIT_TAG"
      - cd pages
      - cargo run
      - git add --all
      - git commit -m "Woodpecker CI Generated Docs"
      - git push
    when:
      # Push new version when version tag is created
      event: tag
      tag: v*
